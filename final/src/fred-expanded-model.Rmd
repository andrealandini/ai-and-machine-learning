---
title: "QE Prediction — Expanded Daily-to-Quarterly Model"
author: "AL"
date: "`r Sys.Date()`"
output:
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r libs}
library(dplyr)
library(tidyr)
library(lubridate)
library(purrr)
library(zoo)
library(ggplot2)
library(fredr)
library(caret)
library(randomForest)
library(xgboost)
library(pROC)
```

```{r api}
FRED_API <- "4ff94616949b02a01853e8effd6b5999"
fredr_set_key(FRED_API)
```

## 1) Fetch daily data and regularize to daily calendar

```{r fetch}
# Helper: fetch a series and standardize columns
get_series <- function(id, start = as.Date("2002-12-18")) {
  fredr(series_id = id, observation_start = start) %>%
    dplyr::select(date, value) %>%
    dplyr::rename(!!id := value)
}

series_ids <- c(
  "WSHOSHO", "M2SL", "FEDFUNDS", "GS10", "BAA10Y",
  "VIXCLS", "UNRATE", "INDPRO", "CPIAUCSL", "T5YIFR"
)

raw_list <- lapply(series_ids, get_series)

# Build daily calendar
date_min <- as.Date("2002-12-18")
date_max <- max(sapply(raw_list, \(x) max(x$date, na.rm = TRUE)))
daily_calendar <- tibble(date = seq(date_min, date_max, by = "day"))

# Merge and fill
daily_all <- reduce(raw_list, \(df, s) dplyr::left_join(df, s, by = "date"), .init = daily_calendar) %>%
  arrange(date) %>%
  mutate(across(-date, ~ zoo::na.locf(., na.rm = FALSE))) %>%
  mutate(across(-date, ~ zoo::na.locf(., fromLast = TRUE)))

cat("NA counts per series after fill:\n")
print(sapply(daily_all[-1], \(x) sum(is.na(x))))
```

## 2) Build quarterly features

```{r features}
# Daily returns for realized vol computation
daily_returns <- daily_all %>%
  arrange(date) %>%
  mutate(
    VIX_ret   = 100 * (VIXCLS / lag(VIXCLS) - 1),
    CPI_ret   = 100 * (CPIAUCSL / lag(CPIAUCSL) - 1),
    INDPRO_ret= 100 * (INDPRO / lag(INDPRO) - 1),
    M2_ret    = 100 * (M2SL / lag(M2SL) - 1)
  )

# Quarter tag
daily_q <- daily_returns %>% mutate(quarter = floor_date(date, "quarter"))

# Aggregate to quarterly
quarterly <- daily_q %>%
  group_by(quarter) %>%
  summarize(
    Fed_Securities = last(WSHOSHO),
    M2             = last(M2SL),
    FedFunds       = last(FEDFUNDS),
    GS10           = last(GS10),
    BAA10Y         = last(BAA10Y),
    VIX            = last(VIXCLS),
    UNRATE         = last(UNRATE),
    INDPRO         = last(INDPRO),
    CPI            = last(CPIAUCSL),
    T5YIFR         = last(T5YIFR),
    Fed_Growth     = 100 * (last(WSHOSHO) / first(WSHOSHO) - 1),
    M2_Growth      = 100 * (last(M2SL) / first(M2SL) - 1),
    INDPRO_Growth  = 100 * (last(INDPRO) / first(INDPRO) - 1),
    CPI_Growth     = 100 * (last(CPIAUCSL) / first(CPIAUCSL) - 1),
    VIX_realized_vol    = sd(VIX_ret, na.rm = TRUE),
    M2_realized_vol     = sd(M2_ret, na.rm = TRUE),
    INDPRO_realized_vol = sd(INDPRO_ret, na.rm = TRUE),
    VIX_max = max(VIXCLS, na.rm = TRUE),
    VIX_min = min(VIXCLS, na.rm = TRUE),
    Rate_Slope = last(GS10) - last(FedFunds),
    .groups = "drop"
  ) %>%
  arrange(quarter) %>%
  mutate(
    Fed_Growth_L1    = lag(Fed_Growth),
    M2_Growth_L1     = lag(M2_Growth),
    INDPRO_Growth_L1 = lag(INDPRO_Growth),
    Rate_Slope_L1    = lag(Rate_Slope),
    VIX_High     = factor(ifelse(VIX > 30, 1, 0)),
    High_Spread  = factor(ifelse(BAA10Y > 2, 1, 0)),
    High_InflExp = factor(ifelse(T5YIFR > 2.5, 1, 0)),
    QE_Next_Quarter = factor(ifelse(lead(Fed_Securities) - Fed_Securities > 100, 1, 0))
  ) %>%
  drop_na(QE_Next_Quarter)
```

## 3) Save outputs

```{r save}
dir.create("../../data", recursive = TRUE, showWarnings = FALSE)
write.csv(daily_all, "../../data/expanded_daily_all.csv", row.names = FALSE)
write.csv(quarterly, "../../data/expanded_quarterly_features.csv", row.names = FALSE)
saveRDS(quarterly, "../../data/expanded_qe_dataset_daily_to_quarterly.rds")
cat("Files saved successfully.\n")
```

## 4) Train Random Forest and XGBoost models

```{r models}
data_ml <- readRDS("../../data/expanded_qe_dataset_daily_to_quarterly.rds")

features <- setdiff(names(data_ml), c("quarter", "QE_Next_Quarter"))
n <- nrow(data_ml)
split_idx <- floor(0.7 * n)
train_data <- data_ml[1:split_idx, ]
test_data  <- data_ml[(split_idx + 1):n, ]

# Random Forest
rf_model <- randomForest(
  x = train_data[, features],
  y = train_data$QE_Next_Quarter,
  ntree = 500,
  mtry = max(2, floor(sqrt(length(features)))),
  importance = TRUE
)
rf_prob <- predict(rf_model, test_data[, features], type = "prob")[, "1"]
rf_cls <- factor(ifelse(rf_prob > 0.5, 1, 0), levels = c(0,1))
rf_cm <- confusionMatrix(rf_cls, test_data$QE_Next_Quarter)
rf_auc <- auc(roc(as.numeric(test_data$QE_Next_Quarter), rf_prob))

cat("Random Forest Accuracy:", rf_cm$overall["Accuracy"], "\n")
cat("Random Forest AUC:", rf_auc, "\n")

# XGBoost
mm_train <- model.matrix(~ . - 1, data = train_data[, features])
mm_test  <- model.matrix(~ . - 1, data = test_data[, features])
prep <- preProcess(mm_train, method = c("center", "scale"))
mm_train_s <- predict(prep, mm_train)
mm_test_s  <- predict(prep, mm_test)

dtrain <- xgb.DMatrix(mm_train_s, label = as.numeric(train_data$QE_Next_Quarter) - 1)
dtest  <- xgb.DMatrix(mm_test_s,  label = as.numeric(test_data$QE_Next_Quarter) - 1)
ratio <- sum(train_data$QE_Next_Quarter == 0) / sum(train_data$QE_Next_Quarter == 1)

params <- list(
  objective = "binary:logistic",
  eval_metric = "auc",
  eta = 0.05,
  max_depth = 4,
  subsample = 0.8,
  colsample_bytree = 0.8,
  min_child_weight = 3,
  scale_pos_weight = ratio
)

xgb_model <- xgb.train(params = params, data = dtrain, nrounds = 400, verbose = 0)
xgb_prob <- predict(xgb_model, dtest)
xgb_cls <- factor(ifelse(xgb_prob > 0.5, 1, 0), levels = c(0,1))
xgb_cm <- confusionMatrix(xgb_cls, test_data$QE_Next_Quarter)
xgb_auc <- auc(roc(as.numeric(test_data$QE_Next_Quarter), xgb_prob))

cat("XGBoost Accuracy:", xgb_cm$overall["Accuracy"], "\n")
cat("XGBoost AUC:", xgb_auc, "\n")

# Feature importance
imp <- xgb.importance(model = xgb_model, feature_names = colnames(mm_train_s))
if (nrow(imp) > 0) {
  xgb.plot.importance(imp, main = "XGBoost Feature Importance")
}
```

## 5) Compare performance

```{r compare}
compare_tbl <- tibble(
  Model = c("Random Forest", "XGBoost"),
  Accuracy = c(as.numeric(rf_cm$overall["Accuracy"]), as.numeric(xgb_cm$overall["Accuracy"])),
  AUC = c(as.numeric(rf_auc), as.numeric(xgb_auc))
)
compare_tbl %>% arrange(desc(AUC))
```

## 6) ROC plots

```{r rocplots}
rf_roc <- roc(as.numeric(test_data$QE_Next_Quarter), rf_prob)
xgb_roc <- roc(as.numeric(test_data$QE_Next_Quarter), xgb_prob)
plot(rf_roc, main = "ROC Curves — Expanded Model")
plot(xgb_roc, add = TRUE, col = "red")
legend("bottomright", legend = c(paste0("RF AUC=", round(as.numeric(rf_auc),3)),
                                 paste0("XGB AUC=", round(as.numeric(xgb_auc),3))),
       lty = c(1,1), col = c("black","red"), bty = "n")
```
